<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventaris Barang</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* [styles remain unchanged] */
  </style>
</head>
<body>
  <div class="container">
    <h2>Form Inventaris Barang BPP</h2>
    <h4 style="text-align:center;">Bidang Penyuluhan Kab. Sambas</h4>
    <form id="inventarisForm">
      <!-- [form fields remain unchanged] -->
      <button type="submit">📦 Simpan Data</button>
    </form>

    <p id="status"></p>

    <div id="logAktivitas">
      <h3>📋 Riwayat Input</h3>
      <ul id="logList"></ul>
    </div>
  </div>

  <div id="connectionStatusBox">📶 Online</div>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbzsr7QQzAJaHlEQHolVd3QiCHA_7kGlHho0byqY7sQlzOZuUmefE5BnIc2pGV6yvlbe/exec";

    function previewImage(input, imgId) {
      const file = input.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        document.getElementById(imgId).src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function getLocation() {
      const input = document.getElementById("titikKoordinat");
      input.placeholder = "📡 Mendeteksi lokasi...";
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude.toFixed(6);
            const lon = pos.coords.longitude.toFixed(6);
            input.value = `${lat}, ${lon}`;
            input.placeholder = "-0.12345, 109.12345";
          },
          (err) => {
            input.placeholder = "-0.12345, 109.12345";
            alert("❌ Gagal mendapatkan lokasi: " + err.message);
          }
        );
      } else {
        alert("❌ Browser tidak mendukung geolokasi.");
      }
    }

    function simpanKeLog(data) {
      const logs = JSON.parse(localStorage.getItem("logInventaris") || "[]");
      logs.push({ waktu: new Date().toLocaleString(), ...data });
      localStorage.setItem("logInventaris", JSON.stringify(logs));
      tampilkanLog();
    }

    function tampilkanLog() {
      const logList = document.getElementById("logList");
      const logs = JSON.parse(localStorage.getItem("logInventaris") || "[]");
      logList.innerHTML = "";

      if (logs.length === 0) {
        logList.innerHTML = "<li>Tidak ada data yang tersimpan.</li>";
        return;
      }

      logs.slice().reverse().forEach(log => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${log.namaBarang}</strong> (${log.namaBPP})<br/>
          Tahun: ${log.tahunRilis}, Kondisi: ${log.kondisiBarang}<br/>
          Lokasi: ${log.titikKoordinat}<br/>
          <small>🕒 ${log.waktu}</small>`;
        logList.appendChild(li);
      });
    }

    document.getElementById('inventarisForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const form = e.target;
      const status = document.getElementById("status");

      if (!navigator.onLine) {
        saveFormToLocal();
        return;
      }

      status.textContent = "⏳ Mengirim data...";

      const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
      });

      try {
        const formData = new URLSearchParams();
        formData.append("namaBPP", form.namaBPP.value);
        formData.append("namaBarang", form.namaBarang.value);
        formData.append("tahunRilis", form.tahunRilis.value);
        formData.append("kondisiBarang", form.kondisiBarang.value);
        formData.append("titikKoordinat", form.titikKoordinat.value);
        formData.append("gambarDepan", await toBase64(document.getElementById('fileDepanKamera').files[0] || document.getElementById('fileDepanGaleri').files[0]));
        formData.append("gambarSamping", await toBase64(document.getElementById('fileSampingKamera').files[0] || document.getElementById('fileSampingGaleri').files[0]));
        formData.append("gambarBelakang", await toBase64(document.getElementById('fileBelakangKamera').files[0] || document.getElementById('fileBelakangGaleri').files[0]));

        const res = await fetch(webAppUrl, { method: "POST", body: formData });
        const resultText = await res.text();

        status.textContent = resultText.includes("success") ? "✅ Data berhasil disimpan" : "❌ Gagal menyimpan data";

        if (resultText.includes("success")) {
          simpanKeLog({
            namaBPP: form.namaBPP.value,
            namaBarang: form.namaBarang.value,
            tahunRilis: form.tahunRilis.value,
            kondisiBarang: form.kondisiBarang.value,
            titikKoordinat: form.titikKoordinat.value
          });

          form.reset();
          ["previewDepan", "previewSamping", "previewBelakang"].forEach(id => document.getElementById(id).src = "");
          ["fileDepanKamera", "fileDepanGaleri", "fileSampingKamera", "fileSampingGaleri", "fileBelakangKamera", "fileBelakangGaleri"]
            .forEach(id => document.getElementById(id).value = "");
        }

      } catch (err) {
        status.textContent = "❌ Terjadi kesalahan: " + err.message;
      }
    });

    function saveFormToLocal() {
      const form = document.getElementById("inventarisForm");
      const data = {
        namaBPP: form.namaBPP.value,
        namaBarang: form.namaBarang.value,
        tahunRilis: form.tahunRilis.value,
        kondisiBarang: form.kondisiBarang.value,
        titikKoordinat: form.titikKoordinat.value
      };
      localStorage.setItem("offlineInventaris", JSON.stringify(data));
      document.getElementById("status").textContent = "📦 Data disimpan sementara (offline)";
      document.getElementById("status").style.color = "orange";
    }

    window.addEventListener("load", () => {
      tampilkanLog();
      const saved = localStorage.getItem("offlineInventaris");
      if (saved) {
        const form = document.getElementById("inventarisForm");
        const data = JSON.parse(saved);
        form.namaBPP.value = data.namaBPP || "";
        form.namaBarang.value = data.namaBarang || "";
        form.tahunRilis.value = data.tahunRilis || "";
        form.kondisiBarang.value = data.kondisiBarang || "";
        form.titikKoordinat.value = data.titikKoordinat || "";
        document.getElementById("status").textContent = "📦 Data belum dikirim (offline)";
        document.getElementById("status").style.color = "orange";
      }
    });

    const statusBox = document.getElementById("connectionStatusBox");
    function updateConnectionStatus(isOnline) {
      statusBox.textContent = isOnline ? "📶 Online" : "📴 Offline - Data disimpan lokal";
      statusBox.classList.toggle("offline", !isOnline);
    }
    updateConnectionStatus(navigator.onLine);
    window.addEventListener("online", () => updateConnectionStatus(true));
    window.addEventListener("offline", () => updateConnectionStatus(false));
  </script>
</body>
</html>
