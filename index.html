<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bangunan dan Inventaris Barang</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background: #f3f4f6; padding: 20px; display: flex; justify-content: center; }
    .container { background: #fff; padding: 2rem; border-radius: 16px; box-shadow: 0 8px 16px rgba(0,0,0,0.05); max-width: 800px; width: 100%; }
    h2, h3 { text-align: center; margin-bottom: 1rem; color: #1f2937; }
    label { display: block; margin: 1rem 0 0.4rem; font-weight: 600; color: #333; }
    input[type="text"], input[type="number"], input[type="file"], select.form-control {
      width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background: #fff; transition: .2s;
    }
    input:focus, select.form-control:focus {
      border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79,70,229,.2);
    }
    select.form-control {
      appearance: none;
      background: url("data:image/svg+xml,%3Csvg fill='gray' height='24' viewBox='0 0 24 24' width='24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right .75rem center / 1.2rem;
    }
    .preview {margin-top:.5rem;max-height:150px;border-radius:8px;border:1px solid #ccc;object-fit:cover;width:100%;}
    .location-group { display:flex; align-items:center; gap:.5rem; }
    .location-group button { background:#e0e7ff; border:none; border-radius:8px; padding:.6rem .8rem; cursor:pointer; transition:.2s; }
    .location-group button:hover { background:#c7d2fe; }
    .info-text { font-size:.85rem; color:#555; margin-top:.2rem; }
    button[type="submit"] { margin-top:1.5rem; width:100%; padding:.9rem; background:#4f46e5; color:#fff; border:none; border-radius:8px; font-size:1rem; font-weight:600; cursor:pointer; transition:.2s; }
    button[type="submit"]:hover { background:#4338ca; }
    #status { margin-top:1rem; font-weight:500; text-align:center; }
    #connectionStatusBox { position:fixed; bottom:16px; right:16px; background:#e5e7eb; color:#111827; font-size:.9rem; padding:.6rem 1rem; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.15); font-weight:600; transition:.3s; }
    #connectionStatusBox.offline { background:#fee2e2; color:#991b1b; }
    #logList { list-style:disc; padding-left:1.2rem; color:#333; }
    #logList li { margin-bottom:1rem; border-bottom:1px dashed #ccc; padding-bottom:.5rem; }
    .fade-toggle { overflow: hidden; transition: max-height 0.4s ease, opacity 0.4s ease; max-height: 1000px; opacity: 1; }
    .fade-toggle.hide { max-height: 0; opacity: 0; padding: 0; margin: 0; pointer-events: none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Form Inventaris Bangunan dan Barang BPP</h2>
    <center><h4>Bidang Penyuluhan <br> Kabupaten Sambas</h4></center>

    <!-- Formulir dan Upload -->
    <!-- ... FORMULIR TIDAK DIEDIT DI SINI UNTUK RINGKASAN ... -->

    <!-- Riwayat Input -->
    <div id="logAktivitas">
      <h3>üìã Riwayat Input</h3>
      <div style="margin-bottom: 1rem;">
        <input type="text" id="filterBPP" placeholder="üîç Filter Nama BPP" style="padding: 0.5rem; width: 48%; margin-right: 4%;">
        <select id="filterKategori" class="form-control" style="width: 48%; display: inline-block;">
          <option value="">üîç Semua Kategori</option>
          <option value="Bangunan">Bangunan</option>
          <option value="Barang">Barang</option>
        </select>
      </div>
      <button id="btnExportExcel" style="margin-bottom: 1rem; background:#bbf7d0; border:none; padding:.6rem 1rem; border-radius:8px; font-weight:600; cursor:pointer;">üìÅ Ekspor ke Excel</button>
      <button id="btnReloadRiwayat" type="button" style="margin-bottom:1rem; background:#e0e7ff; border:none; padding:.6rem 1rem; border-radius:8px; font-weight:600; cursor:pointer;">üîÑ Reload Riwayat</button>
      <ul id="logList"></ul>
      <div style="text-align: center; margin-top: 1rem;">
        <button id="prevPage">‚¨ÖÔ∏è Prev</button>
        <span id="pageInfo" style="margin: 0 1rem;"></span>
        <button id="nextPage">‚û°Ô∏è Next</button>
      </div>
    </div>
  </div>

  <div id="connectionStatusBox">üì∂ Online</div>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbw6iuVEM112ZhX78AY-NK57YS7PIzKPYVI8tHSoSzQ8hznU3G387oZ2k1IaRcr2PrB2pQ/exec";
    let fullData = [], currentPage = 1, pageSize = 5;

    function tampilkanLog(logs) {
      const ul = document.getElementById("logList");
      ul.innerHTML = logs.length ? "" : "<li>üîç Tidak ada data ditemukan.</li>";
      logs.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${item["Nama Barang"]}</strong> (${item["Nama BPP"]})<br/>Kategori: ${item["Kategori"]}, Tahun: ${item["Tahun Rilis"]}, Kondisi: ${item["Kondisi Barang"]}<br/>Lokasi: ${item["Titik Koordinat"]}<br/><small>üïí ${item["Timestamp"]}</small>`;
        ul.appendChild(li);
      });
    }

    function renderPagination(logs) {
      const start = (currentPage - 1) * pageSize;
      const pageData = logs.slice(start, start + pageSize);
      tampilkanLog(pageData);

      const totalPages = Math.ceil(logs.length / pageSize);
      document.getElementById("pageInfo").textContent = `Halaman ${currentPage} dari ${totalPages}`;
      document.getElementById("prevPage").disabled = currentPage === 1;
      document.getElementById("nextPage").disabled = currentPage === totalPages;
    }

    function applyFilter() {
      const bpp = document.getElementById("filterBPP").value.toLowerCase();
      const kategori = document.getElementById("filterKategori").value;
      const filtered = fullData.filter(item => {
        const matchBPP = item["Nama BPP"]?.toLowerCase().includes(bpp);
        const matchKategori = kategori === "" || item["Kategori"] === kategori;
        return matchBPP && matchKategori;
      });
      currentPage = 1;
      renderPagination(filtered);
    }

    document.getElementById("filterBPP").addEventListener("input", applyFilter);
    document.getElementById("filterKategori").addEventListener("change", applyFilter);

    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        applyFilter();
      }
    });
    document.getElementById("nextPage").addEventListener("click", () => {
      currentPage++;
      applyFilter();
    });

    document.getElementById("btnExportExcel").addEventListener("click", () => {
      const csv = fullData.map(row => 
        `"${row["Nama BPP"]}","${row["Kategori"]}","${row["Nama Barang"]}","${row["Tahun Rilis"]}","${row["Kondisi Barang"]}","${row["Titik Koordinat"]}","${row["Timestamp"]}"`
      ).join("\n");
      const blob = new Blob(["Nama BPP,Kategori,Nama Barang,Tahun,Kondisi,Koordinat,Timestamp\n" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "riwayat_inventaris.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    async function fetchRiwayatGlobal() {
      try {
        const res = await fetch(webAppUrl);
        fullData = await res.json();
        applyFilter();
      } catch (err) {
        document.getElementById("logList").innerHTML = "<li>Gagal memuat riwayat</li>";
      }
    }

    function updateConnectionStatus(online) {
      const box = document.getElementById("connectionStatusBox");
      box.textContent = online ? "üì∂ Online" : "üì¥ Offline";
      box.classList.toggle("offline", !online);
    }

    window.addEventListener("load", () => {
      fetchRiwayatGlobal();
      updateConnectionStatus(navigator.onLine);
      document.getElementById("btnReloadRiwayat").addEventListener("click", fetchRiwayatGlobal);
    });

    window.addEventListener("online", () => updateConnectionStatus(true));
    window.addEventListener("offline", () => updateConnectionStatus(false));
  </script>
</body>
</html>
